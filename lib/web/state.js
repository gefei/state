var state=function(t){var e={};function r(i){if(e[i])return e[i].exports;var n=e[i]={i:i,l:!1,exports:{}};return t[i].call(n.exports,n,n.exports,r),n.l=!0,n.exports}return r.m=t,r.c=e,r.d=function(t,e,i){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)r.d(i,n,function(e){return t[e]}.bind(null,n));return i},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=0)}([function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.JSONSerializer=e.Visitor=e.Instance=e.Transition=e.PseudoState=e.State=e.Region=e.Vertex=e.TransitionKind=e.PseudoStateKind=e.random=e.log=void 0;var i=r(4);Object.defineProperty(e,"log",{enumerable:!0,get:function(){return i.log}});var n=r(1);Object.defineProperty(e,"random",{enumerable:!0,get:function(){return n.random}});var s=r(2);Object.defineProperty(e,"PseudoStateKind",{enumerable:!0,get:function(){return s.PseudoStateKind}});var o=r(3);Object.defineProperty(e,"TransitionKind",{enumerable:!0,get:function(){return o.TransitionKind}});var a=r(5);Object.defineProperty(e,"Vertex",{enumerable:!0,get:function(){return a.Vertex}});var u=r(6);Object.defineProperty(e,"Region",{enumerable:!0,get:function(){return u.Region}});var c=r(7);Object.defineProperty(e,"State",{enumerable:!0,get:function(){return c.State}});var d=r(8);Object.defineProperty(e,"PseudoState",{enumerable:!0,get:function(){return d.PseudoState}});var h=r(9);Object.defineProperty(e,"Transition",{enumerable:!0,get:function(){return h.Transition}});var l=r(13);Object.defineProperty(e,"Instance",{enumerable:!0,get:function(){return l.Instance}});var g=r(15);Object.defineProperty(e,"Visitor",{enumerable:!0,get:function(){return g.Visitor}});var f=r(16);Object.defineProperty(e,"JSONSerializer",{enumerable:!0,get:function(){return f.JSONSerializer}})},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.random=void 0,function(t){let e=t=>Math.floor(Math.random()*t);t.get=function(t){return t[e(t.length)]},t.set=function(t){const r=e;return e=t,r}}(e.random||(e.random={}))},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.PseudoStateKind=void 0,function(t){t[t.Choice=1]="Choice",t[t.DeepHistory=2]="DeepHistory",t[t.Initial=4]="Initial",t[t.Junction=8]="Junction",t[t.ShallowHistory=16]="ShallowHistory",t[t.History=18]="History",t[t.Starting=22]="Starting"}(e.PseudoStateKind||(e.PseudoStateKind={}))},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.TransitionKind=void 0,function(t){t[t.External=0]="External",t[t.Local=1]="Local"}(e.TransitionKind||(e.TransitionKind={}))},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.log=void 0,function(t){const e=[];t.Create=1,t.Entry=2,t.Exit=4,t.Evaluate=8,t.Transition=16,t.User=128,t.add=function(t,...r){return e.push({consumer:t,category:r.reduce((t,e)=>t|e)})},t.remove=function(t){delete e[t]},t.write=function(t,r){let i;e.forEach(e=>{e&&r&e.category&&e.consumer(i||(i=t()))})}}(e.log||(e.log={}))},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Vertex=void 0;const i=r(0);e.Vertex=class{constructor(t){this.name=t,this.outgoing=[],i.log.write(()=>`Created ${this}`,i.log.Create)}on(t){return new i.Transition(this).on(t)}when(t){return new i.Transition(this).when(t)}to(t,e=i.TransitionKind.External){return new i.Transition(this).to(t,e)}isActive(t){return void 0===this.parent||t.getVertex(this.parent)===this}evaluate(t,e,r){const i=this.getTransition(r);return!!i&&(i.traverse(t,e,r),!0)}getTransition(t){return this.outgoing.find(e=>e.evaluate(t))}doEnter(t,e,r){this.doEnterHead(t,e,r,void 0),this.doEnterTail(t,e,r)}doEnterHead(t,e,r,n){i.log.write(()=>`${t.instance} enter ${this}`,i.log.Entry),t.setVertex(this)}doExit(t,e,r){i.log.write(()=>`${t.instance} leave ${this}`,i.log.Exit)}toString(){return this.parent?`${this.parent}.${this.name}`:this.name}}},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Region=void 0;const i=r(0);function n(t,e,r){return e||void 0!==t.initial&&!!(t.initial.kind&r)}e.Region=class{constructor(t,e){this.name=t,this.parent=e,this.vertices=[],i.log.write(()=>`Created ${this}`,i.log.Create),e.regions.push(this)}isComplete(t){const e=t.get(this);return void 0!==e&&e.isFinal()}doEnter(t,e,r){this.doEnterHead(t),this.doEnterTail(t,e,r)}doEnterHead(t){i.log.write(()=>`${t.instance} enter ${this}`,i.log.Entry)}doEnterTail(t,e,r){const s=t.get(this),o=s&&n(this,e,i.PseudoStateKind.History)?s:this.initial;if(!o)throw new Error(`Unable to find starting state in region ${this}`);o.doEnter(t,n(this,e,i.PseudoStateKind.DeepHistory),r)}doExit(t,e,r){const n=t.getVertex(this);n&&n.doExit(t,e,r),i.log.write(()=>`${t.instance} leave ${this}`,i.log.Exit)}accept(t){t.visitRegion(this),this.vertices.forEach(e=>e.accept(t)),t.visitRegionTail(this)}toString(){return`${this.parent}.${this.name}`}}},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.State=void 0;const i=r(0);class n extends i.Vertex{constructor(t,e){super(t),this.regions=[],this.deferrableTriggers=[],this.entryActions=[],this.exitActions=[],this.parent=e instanceof n?e.getDefaultRegion():e,this.parent&&this.parent.vertices.push(this)}entry(...t){return this.entryActions.push(...t),this}exit(...t){return this.exitActions.push(...t),this}defer(...t){return this.deferrableTriggers.push(...t),this}getDefaultRegion(){return this.defaultRegion||(this.defaultRegion=new i.Region("default",this))}isSimple(){return 0===this.regions.length}isComposite(){return this.regions.length>0}isOrthogonal(){return this.regions.length>1}isFinal(){return 0===this.outgoing.length}isComplete(t){return!this.regions.some(e=>!e.isComplete(t))}evaluate(t,e,r){const i=this.delegate(t,e,r)||super.evaluate(t,e,r)||this.deferrable(t,r);return i&&this.completion(t,e),i}delegate(t,e,r){let i=!1;for(let n=0,s=this.regions.length;n<s&&this.isActive(t);++n){const s=t.get(this.regions[n]);s&&(i=s.evaluate(t,e,r)||i)}return i}deferrable(t,e){return-1!==this.deferrableTriggers.indexOf(e.constructor)&&(t.instance.defer(e),!0)}getDeferrableTriggers(t){return this.regions.reduce((e,r)=>{const i=t.get(r);return void 0!==i?e.concat(i.getDeferrableTriggers(t)):e},this.deferrableTriggers)}doEnterHead(t,e,r,i){i&&this.regions.forEach(n=>{n!==i&&n.doEnter(t,e,r)}),super.doEnterHead(t,e,r,i),this.entryActions.forEach(e=>e(r,t.instance))}doEnterTail(t,e,r){this.regions.forEach(i=>i.doEnter(t,e,r)),this.completion(t,e)}doExit(t,e,r){this.regions.forEach(i=>i.doExit(t,e,r)),super.doExit(t,e,r),this.exitActions.forEach(e=>e(r,t.instance))}completion(t,e){this.isComplete(t)&&super.evaluate(t,e,this)}accept(t){t.visitState(this),this.regions.forEach(e=>e.accept(t)),t.visitStateTail(this)}}e.State=n},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.PseudoState=void 0;const i=r(1),n=r(0),s=r(3);class o extends n.Vertex{constructor(t,e,r=n.PseudoStateKind.Initial){super(t),this.kind=r,this.parent=e instanceof n.State?e.getDefaultRegion():e,this.parent.vertices.push(this),this.kind&n.PseudoStateKind.Starting&&(this.parent.initial=this)}else(t,e=s.TransitionKind.External){return this.elseTransition=new n.Transition(this).to(t,e).when(()=>!1)}getTransition(t){return(this.kind===n.PseudoStateKind.Choice?i.random.get(this.outgoing.filter(e=>e.evaluate(t))):super.getTransition(t))||this.elseTransition}doEnterTail(t,e,r){this.kind!==n.PseudoStateKind.Junction&&this.evaluate(t,e,r)}accept(t){t.visitPseudoState(this),t.visitPseudoStateTail(this)}}e.PseudoState=o},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Transition=void 0;const i=r(0),n=r(10),s=r(11),o=r(12);e.Transition=class{constructor(t){this.source=t,this.guard=()=>!0,this.traverseActions=[],this.target=t,this.strategy=new s.InternalTransitionStrategy(this.target),this.source.outgoing.push(this)}on(t){return this.eventType=t,this}when(t){return this.guard=t,this}to(t,e=i.TransitionKind.External){return this.target=t,e===i.TransitionKind.External?this.strategy=new n.ExternalTransitionStrategy(this.source,this.target):this.strategy=new o.LocalTransitionStrategy(this.target),this}effect(...t){return this.traverseActions.push(...t),this}evaluate(t){return(void 0===this.eventType||t.constructor===this.eventType)&&this.guard(t)}traverse(t,e,r){var n=this;const s=[n];for(;n.target instanceof i.PseudoState&&n.target.kind===i.PseudoStateKind.Junction;)s.push(n=n.target.getTransition(r));s.forEach(i=>i.execute(t,e,r))}execute(t,e,r){i.log.write(()=>`${t.instance} traverse ${this}`,i.log.Transition),this.strategy.doExitSource(t,e,r),this.traverseActions.forEach(e=>e(r,t.instance)),this.strategy.doEnterTarget(t,e,r)}toString(){return`${this.strategy} transition from ${this.source} to ${this.target}`}}},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ExternalTransitionStrategy=void 0;const i=r(0),n=r(2);function*s(t){t.parent&&(yield*s(t.parent)),yield t}e.ExternalTransitionStrategy=class{constructor(t,e){const r=s(t),o=s(e);let a=r.next(),u=o.next();do{this.toExit=a.value,this.toEnter=[u.value],a=r.next(),u=o.next()}while(this.toExit===this.toEnter[0]&&!a.done&&!u.done);for(;!u.done;)this.toEnter.push(u.value),u=o.next();e instanceof i.PseudoState&&e.kind&n.PseudoStateKind.History&&this.toEnter.pop()}doExitSource(t,e,r){this.toExit.doExit(t,e,r)}doEnterTarget(t,e,r){this.toEnter.forEach((i,n)=>i.doEnterHead(t,e,r,this.toEnter[n+1])),this.toEnter[this.toEnter.length-1].doEnterTail(t,e,r)}toString(){return"external"}}},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.InternalTransitionStrategy=void 0;const i=r(0);e.InternalTransitionStrategy=class{constructor(t){this.target=t}doEnterTarget(t,e){this.target instanceof i.State&&this.target.completion(t,e)}doExitSource(){}toString(){return"internal"}}},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.LocalTransitionStrategy=void 0;e.LocalTransitionStrategy=class{constructor(t){this.target=t}doExitSource(t,e,r){if(this.vertexToEnter=function(t,e){for(;e.parent&&e.parent.parent&&!e.parent.parent.isActive(t);)e=e.parent.parent;return e}(t,this.target),!this.vertexToEnter.isActive(t)&&this.vertexToEnter.parent){const i=t.getVertex(this.vertexToEnter.parent);i&&i.doExit(t,e,r)}}doEnterTarget(t,e,r){this.vertexToEnter&&!this.vertexToEnter.isActive(t)&&this.vertexToEnter.doEnter(t,e,r)}toString(){return"local"}}},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Instance=void 0;const i=r(0),n=r(14);class s extends Map{constructor(t,e){super(),this.name=t,this.root=e,this.deferredEventPool=[],this.transactional(t=>{this.root.doEnter(t,!1,this.root),this.evaluateDeferred(t)})}evaluate(t){return i.log.write(()=>`${this} evaluate ${t}`,i.log.Evaluate),this.transaction?(this.defer(t),!1):this.transactional(e=>{const r=this.root.evaluate(e,!1,t);return r&&this.evaluateDeferred(e),r})}transactional(t){try{this.transaction=new n.Transaction(this);const e=t(this.transaction);for(const[t,e]of this.transaction)this.set(t,e);return e}finally{this.transaction=void 0}}defer(t){i.log.write(()=>`${this} deferring ${t}`,i.log.Evaluate),this.deferredEventPool.push(t)}evaluateDeferred(t){0!==this.deferredEventPool.length&&(this.processDeferred(t),this.deferredEventPool=this.deferredEventPool.filter(t=>t))}processDeferred(t){this.deferredEventPool.forEach((e,r)=>{e&&-1===this.root.getDeferrableTriggers(t).indexOf(e.constructor)&&(delete this.deferredEventPool[r],i.log.write(()=>`${this} evaluate deferred ${e}`,i.log.Evaluate),this.root.evaluate(t,!1,e))&&this.processDeferred(t)})}toString(){return this.name}}e.Instance=s},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Transaction=void 0;const i=r(0);class n extends Map{constructor(t){super(),this.instance=t,this.lastKnownVertex=new Map}get(t){return super.get(t)||this.instance.get(t)}setVertex(t){t.parent&&(this.lastKnownVertex.set(t.parent,t),t instanceof i.State&&this.set(t.parent,t))}getVertex(t){return this.lastKnownVertex.get(t)||this.instance.get(t)}}e.Transaction=n},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Visitor=void 0;e.Visitor=class{visitState(t){}visitStateTail(t){}visitPseudoState(t){}visitPseudoStateTail(t){}visitRegion(t){}visitRegionTail(t){}}},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.JSONSerializer=void 0;const i=r(0);class n{constructor(t){this.name=t.name}}class s extends n{constructor(t){super(t),this.children=[]}}class o extends n{constructor(t,e){super(t),this.activeState=e,this.children=[]}}class a extends i.Visitor{constructor(t,e){super(),this.instance=t,this.deferedEventSerializer=e,this.stateMap=new Map,this.regionMap=new Map}visitState(t){const e=new s(t);if(this.stateMap.set(t,e),void 0!==t.parent){const r=this.regionMap.get(t.parent);r&&r.children.push(e)}else this.root=e}visitRegion(t){const e=this.instance.get(t),r=new o(t,e?e.name:void 0);this.regionMap.set(t,r);const i=this.stateMap.get(t.parent);i&&i.children.push(r)}toString(){return 0!==this.instance.deferredEventPool.length&&this.deferedEventSerializer&&this.root&&(this.root.deferredEventPool=this.instance.deferredEventPool.map(this.deferedEventSerializer)),JSON.stringify(this.root)}}e.JSONSerializer=a}]);